@page "/account"

@using System.Security.Claims
@using BlazorApp.Services.User
@using BlazorApp.Services.Auth
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using ApiContracts.User


@inject AuthenticationStateProvider AuthProvider
@inject IUserService UserService
@inject BlazorApp.Services.Auth.AuthProvider Auth

<AuthorizeView Context="authState">
    <NotAuthorized>
        <p>You must be logged in to view this page.</p>
        <a href="/login">Go to Login</a>
    </NotAuthorized>

    <Authorized>

    @{
        var user = authState.User;

        var displayNameLive =
            user.FindFirst(ClaimTypes.Name)?.Value ??
            user.Identity?.Name ??
            "";

        var emailLive =
            user.FindFirst(ClaimTypes.Email)?.Value ??
            "";

        var idClaim = user.FindFirst("Id")?.Value;
        long.TryParse(idClaim, out userId); // update userId live too
    }
        <h3>Account</h3>

        @if (!isEditing)
        {
            <p><strong>Display name:</strong> @displayNameLive</p>
            <p><strong>Email:</strong> @emailLive</p>

            <button class="btn btn-primary" @onclick="() => StartEdit(displayNameLive, emailLive)">Edit</button>

            @if (!string.IsNullOrWhiteSpace(statusMessage))
            {
                <p class="mt-3" style="color:@(isError ? "red" : "green")">@statusMessage</p>
            }
        }
        else
        {
            <EditForm Model="@editModel" OnValidSubmit="@SaveChanges">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label">Display name</label>
                    <InputText class="form-control" @bind-Value="editModel.DisplayName" />
                    <ValidationMessage For="@(() => editModel.DisplayName)" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <InputText class="form-control" @bind-Value="editModel.Email" />
                    <ValidationMessage For="@(() => editModel.Email)" />
                </div>

                <hr />
                <h5>Change password (optional)</h5>

                <div class="mb-3">
                    <label class="form-label">Current password</label>
                    <InputText type="password" class="form-control" @bind-Value="editModel.CurrentPassword" />
                    @if (!string.IsNullOrWhiteSpace(passwordError))
                    {
                        <div class="text-danger">@passwordError</div>
                    }
                </div>

                <div class="mb-3">
                    <label class="form-label">New password</label>
                    <InputText type="password" class="form-control" @bind-Value="editModel.NewPassword" />
                    @if (!string.IsNullOrWhiteSpace(newPasswordError))
                    {
                        <div class="text-danger">@newPasswordError</div>
                    }
                </div>

                <div class="mb-3">
                    <label class="form-label">Confirm new password</label>
                    <InputText type="password" class="form-control" @bind-Value="editModel.ConfirmNewPassword" />
                    @if (!string.IsNullOrWhiteSpace(confirmError))
                    {
                        <div class="text-danger">@confirmError</div>
                    }
                </div>

                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="CancelEdit">Cancel</button>

                @if (!string.IsNullOrWhiteSpace(statusMessage))
                {
                    <p class="mt-3" style="color:@(isError ? "red" : "green")">@statusMessage</p>
                }
            </EditForm>
        }
    </Authorized>
</AuthorizeView>

@code {
    private long userId;
    private string email = "";
    private string displayName = "";

    private bool isEditing;

    private string? statusMessage;
    private bool isError;

    private string? passwordError;
    private string? newPasswordError;
    private string? confirmError;

    private AccountEditModel editModel = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst("Id")?.Value;
            if (!long.TryParse(idClaim, out userId))
                userId = 0;

            displayName = user.FindFirst(ClaimTypes.Name)?.Value
                          ?? user.Identity?.Name
                          ?? "";

            email = user.FindFirst(ClaimTypes.Email)?.Value
                    ?? "";
        }
    }

    private void StartEdit(string currentName, string currentEmail)
    {
        statusMessage = null;
        isError = false;

        passwordError = null;
        newPasswordError = null;
        confirmError = null;

        editModel = new AccountEditModel
        {
            DisplayName = currentName,
            Email = currentEmail,
            CurrentPassword = "",
            NewPassword = "",
            ConfirmNewPassword = ""
        };

        isEditing = true;
    }


    private void CancelEdit()
    {
        isEditing = false;

        passwordError = null;
        newPasswordError = null;
        confirmError = null;
    }

    private async Task SaveChanges()
    {
        statusMessage = null;
        isError = false;

        passwordError = null;
        newPasswordError = null;
        confirmError = null;

        if (userId <= 0)
        {
            isError = true;
            statusMessage = "Cannot update: user id is missing. Please log out and log in again.";
            return;
        }

        bool wantsPasswordChange =
            !string.IsNullOrWhiteSpace(editModel.CurrentPassword) ||
            !string.IsNullOrWhiteSpace(editModel.NewPassword) ||
            !string.IsNullOrWhiteSpace(editModel.ConfirmNewPassword);

        if (wantsPasswordChange)
        {
            if (string.IsNullOrWhiteSpace(editModel.CurrentPassword))
            {
                passwordError = "Current password is required.";
                return;
            }

            if (string.IsNullOrWhiteSpace(editModel.NewPassword) || editModel.NewPassword.Length < 6)
            {
                newPasswordError = "New password must be at least 6 characters.";
                return;
            }

            if (!string.Equals(editModel.NewPassword, editModel.ConfirmNewPassword, StringComparison.Ordinal))
            {
                confirmError = "Passwords do not match.";
                return;
            }
        }

        try
        {
            var changedName = !string.Equals(editModel.DisplayName, displayName, StringComparison.Ordinal);
            var changedEmail = !string.Equals(editModel.Email, email, StringComparison.OrdinalIgnoreCase);

            // Apply updates to backend
            if (changedName)
            {
                await UserService.UpdateUserNameAsync(userId, editModel.DisplayName);
                displayName = editModel.DisplayName;
            }

            if (changedEmail)
            {
                await UserService.UpdateUserEmailAsync(userId, editModel.Email);
                email = editModel.Email;
            }

            if (wantsPasswordChange)
            {
                await UserService.UpdateUserPasswordAsync(
                    userId,
                    email, // updated email if changed
                    editModel.CurrentPassword!,
                    editModel.NewPassword!
                );
            }

            // Update auth claims + localStorage so refresh shows new values
            if (changedName || changedEmail)
            {
                var updatedUser = new UserDto
                {
                    Id = userId,
                    DisplayName = displayName,
                    Email = email
                };

                await Auth.UpdateClaimsAndPersistAsync(updatedUser);
            }

            // Clear sensitive fields
            editModel.CurrentPassword = "";
            editModel.NewPassword = "";
            editModel.ConfirmNewPassword = "";

            statusMessage = "Account updated successfully.";
            isEditing = false;
        }
        catch (Exception ex)
        {
            isError = true;
            statusMessage = ex.Message;
        }
    }


    public class AccountEditModel
    {
        [Required]
        public string DisplayName { get; set; } = "";

        [Required, EmailAddress]
        public string Email { get; set; } = "";

        public string? CurrentPassword { get; set; }
        public string? NewPassword { get; set; }
        public string? ConfirmNewPassword { get; set; }
    }
}
