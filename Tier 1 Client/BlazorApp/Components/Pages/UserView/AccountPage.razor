@page "/account"

@using System.Security.Claims
@using BlazorApp.Services.Auth
@using System.ComponentModel.DataAnnotations
@using ApiContracts.User
@using BlazorApp.Models
@using BlazorApp.Services.User
@inject AuthenticationStateProvider AuthProvider
@inject IUserService UserService
@inject AuthProvider Auth

<PageTitle>AccountPage</PageTitle>

<AuthorizeView Context="authState">
    <NotAuthorized>
        <p>You must be logged in to view this page.</p>
        <a href="/login">Go to Login</a>
    </NotAuthorized>
    
    <Authorized>
    @{
        var user = authState.User;

        var displayNameLive =
            user.FindFirst(ClaimTypes.Name)?.Value ??
            user.Identity?.Name ??
            "";

        var emailLive =
            user.FindFirst(ClaimTypes.Email)?.Value ??
            "";

        var idClaim = user.FindFirst("Id")?.Value;
        long.TryParse(idClaim, out _userId); // update userId live too
    }
        <h3>Account</h3>

        @if (!_isEditing)
        {
            <p><strong>Display name:</strong> @displayNameLive</p>
            <p><strong>Email:</strong> @emailLive</p>

            <button class="btn btn-primary" @onclick="() => StartEdit(displayNameLive, emailLive)">Edit</button>

            @if (!string.IsNullOrWhiteSpace(_statusMessage))
            {
                <p class="mt-3" style="color:@(_isError ? "red" : "green")">@_statusMessage</p>
            }
        }
        else
        {
            <EditForm Model="@_editModel" OnValidSubmit="@SaveChanges">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label">Display name</label>
                    <InputText class="form-control" @bind-Value="_editModel.DisplayName" />
                    <ValidationMessage For="@(() => _editModel.DisplayName)" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <InputText class="form-control" @bind-Value="_editModel.Email" />
                    <ValidationMessage For="@(() => _editModel.Email)" />
                </div>

                <hr />
                <h5>Change password (optional)</h5>

                <div class="mb-3">
                    <label class="form-label">Current password</label>
                    <InputText type="password" class="form-control" @bind-Value="_editModel.CurrentPassword" />
                    @if (!string.IsNullOrWhiteSpace(_passwordError))
                    {
                        <div class="text-danger">@_passwordError</div>
                    }
                </div>

                <div class="mb-3">
                    <label class="form-label">New password</label>
                    <InputText type="password" class="form-control" @bind-Value="_editModel.NewPassword" />
                    @if (!string.IsNullOrWhiteSpace(_newPasswordError))
                    {
                        <div class="text-danger">@_newPasswordError</div>
                    }
                </div>

                <div class="mb-3">
                    <label class="form-label">Confirm new password</label>
                    <InputText type="password" class="form-control" @bind-Value="_editModel.ConfirmNewPassword" />
                    @if (!string.IsNullOrWhiteSpace(_confirmError))
                    {
                        <div class="text-danger">@_confirmError</div>
                    }
                </div>

                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="CancelEdit">Cancel</button>

                @if (!string.IsNullOrWhiteSpace(_statusMessage))
                {
                    <p class="mt-3" style="color:@(_isError ? "red" : "green")">@_statusMessage</p>
                }
            </EditForm>
        }
    </Authorized>
</AuthorizeView>

@code {
    private long _userId;
    private string _email = "";
    private string _displayName = "";

    private bool _isEditing;

    private string? _statusMessage;
    private bool _isError;

    private string? _passwordError;
    private string? _newPasswordError;
    private string? _confirmError;

    private AccountEditModel _editModel = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst("Id")?.Value;
            if (!long.TryParse(idClaim, out _userId))
                _userId = 0;

            _displayName = user.FindFirst(ClaimTypes.Name)?.Value
                          ?? user.Identity?.Name
                          ?? "";

            _email = user.FindFirst(ClaimTypes.Email)?.Value
                    ?? "";
        }
    }

    private void StartEdit(string currentName, string currentEmail)
    {
        _statusMessage = null;
        _isError = false;

        _passwordError = null;
        _newPasswordError = null;
        _confirmError = null;

        _editModel = new AccountEditModel
        {
            DisplayName = currentName,
            Email = currentEmail,
            CurrentPassword = "",
            NewPassword = "",
            ConfirmNewPassword = ""
        };

        _isEditing = true;
    }
    
    private void CancelEdit()
    {
        _isEditing = false;

        _passwordError = null;
        _newPasswordError = null;
        _confirmError = null;
    }

    private async Task SaveChanges()
    {
        _statusMessage = null;
        _isError = false;

        _passwordError = null;
        _newPasswordError = null;
        _confirmError = null;

        if (_userId <= 0)
        {
            _isError = true;
            _statusMessage = "Cannot update: user id is missing. Please log out and log in again.";
            return;
        }

        bool wantsPasswordChange =
            !string.IsNullOrWhiteSpace(_editModel.CurrentPassword) ||
            !string.IsNullOrWhiteSpace(_editModel.NewPassword) ||
            !string.IsNullOrWhiteSpace(_editModel.ConfirmNewPassword);

        if (wantsPasswordChange)
        {
            if (string.IsNullOrWhiteSpace(_editModel.CurrentPassword))
            {
                _passwordError = "Current password is required.";
                return;
            }

            if (string.IsNullOrWhiteSpace(_editModel.NewPassword) || _editModel.NewPassword.Length < 6)
            {
                _newPasswordError = "New password must be at least 6 characters.";
                return;
            }

            if (!string.Equals(_editModel.NewPassword, _editModel.ConfirmNewPassword, StringComparison.Ordinal))
            {
                _confirmError = "Passwords do not match.";
                return;
            }
        }

        try
        {
            var changedName = !string.Equals(_editModel.DisplayName, _displayName, StringComparison.Ordinal);
            var changedEmail = !string.Equals(_editModel.Email, _email, StringComparison.OrdinalIgnoreCase);

            // Apply updates to backend
            if (changedName)
            {
                await UserService.UpdateUserNameAsync(_userId, _editModel.DisplayName);
                _displayName = _editModel.DisplayName;
            }

            if (changedEmail)
            {
                await UserService.UpdateUserEmailAsync(_userId, _editModel.Email);
                _email = _editModel.Email;
            }

            if (wantsPasswordChange)
            {
                await UserService.UpdateUserPasswordAsync(
                    _userId,
                    _email, // updated email if changed
                    _editModel.CurrentPassword!,
                    _editModel.NewPassword!
                );
            }

            // Update auth claims + localStorage so refresh shows new values
            if (changedName || changedEmail)
            {
                var updatedUser = new UserDto
                {
                    Id = _userId,
                    DisplayName = _displayName,
                    Email = _email
                };

                await Auth.UpdateClaimsAndPersistAsync(updatedUser);
            }

            // Clear sensitive fields
            _editModel.CurrentPassword = "";
            _editModel.NewPassword = "";
            _editModel.ConfirmNewPassword = "";

            _statusMessage = "Account updated successfully.";
            _isEditing = false;
        }
        catch (Exception ex)
        {
            _isError = true;
            _statusMessage = ex.Message;
        }
    }
}
