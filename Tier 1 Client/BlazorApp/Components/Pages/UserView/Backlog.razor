@page "/backlog"

@using ApiContracts.Quest
@using ApiContracts.User
@using BlazorApp.Components.Pages.Auth
@using BlazorApp.Services.Auth
@using BlazorApp.Services.Quest
@using BlazorApp.Models
@using BlazorApp.Components.ComponentItems.Quest

@inject IQuestService questService
@inject IUserService userService
@inject QuestHubService HubService
@inject AuthenticationStateProvider AuthProvider
@inject IQuestService QuestService


@implements IDisposable

<AuthorizeView>
    <NotAuthorized>
        <RedirectToLogin/>
    </NotAuthorized>

    <Authorized>
        <h3>Backlog - All Quests</h3>
        <button class="btn btn-primary" @onclick="OpenModal">
            Create New Quest
        </button>
        
        <CreateQuestModal @ref="createQuestModal"
                          OnConfirm="HandleQuestCreate"
                          OnCancel="HandleCancel" />

        @if (isLoading)
        {
            <p>Loading...</p>
        }
        else if (errorMessage != null)
        {
            <p style="color: red;">Error: @errorMessage</p>
        }
        else
        {
            <div class="filters">
                <div class="filter-group">
                    <label>Title:</label>
                    <input type="text" @bind="titleFilter" @bind:event="oninput" placeholder="Search title..." />
                </div>
                
                <div class="filter-group">
                    <label>Status:</label>
                    <select @bind="statusFilter">
                        <option value="">All</option>
                        @foreach (var status in Enum.GetValues<QuestStatus>())
                        {
                            <option value="@status">@status</option>
                        }
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Created By:</label>
                    <select @bind="userIdFilter">
                        <option value="">All</option>
                        @foreach (var user in allUsers)
                        {
                            <option value="@user.Id">@user.DisplayName</option>
                        }
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Assignee:</label>
                    <select @bind="assigneeFilter">
                        <option value="">All</option>
                        @foreach (var user in allUsers)
                        {
                            <option value="@user.Id">@user.DisplayName</option>
                        }
                    </select>
                </div>
            </div>
            
            <p>Showing @GetFilteredQuests().Count of @allQuests.Count quests</p>
            
            <table class="quest-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Created By</th>
                        <th>Assignee</th>
                        <th>Start Date</th>
                        <th>Deadline</th>
                        <th>Finished Date</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var quest in GetFilteredQuests())
                    {
                        <tr>
                            <td>@quest.Title</td>
                            <td>@quest.Description</td>
                            <td>@quest.Status</td>
                            <td>@quest.CreatedBy.DisplayName</td>
                            <td>@(quest.Assignee?.DisplayName ?? "-")</td>
                            <td>@(quest.StartDate?.ToShortDateString() ?? "-")</td>
                            <td>@(quest.Deadline?.ToShortDateString() ?? "-")</td>
                            <td>@(quest.FinishedDate?.ToShortDateString() ?? "-")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </Authorized>
</AuthorizeView>



@code {
    private List<QuestDto> allQuests = new();
    private List<UserDto> allUsers = new();
    private bool isLoading = true;
    private string? errorMessage;
    
    private CreateQuestModal? createQuestModal;
    
    // Filter state
    private string titleFilter = "";
    private string statusFilter = "";
    private string userIdFilter = "";
    private string assigneeFilter = "";

    protected override async Task OnInitializedAsync()
    {
        await HubService.ConnectAsync("https://localhost:7009/questhub");
        // Subscribe to SignalR events
        HubService.OnQuestChanged += RefreshQuests;
        
        try
        {
            // Load both quests and users
            var questTask = questService.GetAllQuestsAsync();
            var userTask = userService.GetAllUsersAsync();
            
            await Task.WhenAll(questTask, userTask);
            
            allQuests = questTask.Result;
            allUsers = userTask.Result;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    //Called by SignalR when any quest changes
    private async void RefreshQuests()
    {
        try
        {
            // Reload only quests (users don't change)
            allQuests = await questService.GetAllQuestsAsync();
            
            // Trigger UI refresh on Blazor thread
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }

    private List<QuestDto> GetFilteredQuests()
    {
        var filtered = allQuests.AsEnumerable();
        
        // Filter by title
        if (!string.IsNullOrWhiteSpace(titleFilter))
        {
            filtered = filtered.Where(q => 
                q.Title.Contains(titleFilter, StringComparison.OrdinalIgnoreCase));
        }
        
        // Filter by status
        if (!string.IsNullOrWhiteSpace(statusFilter))
        {
            var status = Enum.Parse<QuestStatus>(statusFilter);
            filtered = filtered.Where(q => q.Status == status);
        }
        
        // Filter by user
        if (!string.IsNullOrWhiteSpace(userIdFilter))
        {
            var userId = long.Parse(userIdFilter);
            filtered = filtered.Where(q => q.CreatedBy.Id == userId);
        }
        
        // Filter by assignee
        if (!string.IsNullOrWhiteSpace(assigneeFilter))
        {
            var assigneeId = long.Parse(assigneeFilter);
            filtered = filtered.Where(q => q.Assignee != null && q.Assignee.Id == assigneeId);
        }

        return filtered.ToList();
    }

    // NEW METHOD: Cleanup on component dispose
    public void Dispose()
    {
        HubService.OnQuestChanged -= RefreshQuests;
    }
    
    
    //Method to open the Create task popup
    
    private async Task OpenModal()
    {
        if (createQuestModal != null)
            await createQuestModal.Show();
    }
    
    private async Task HandleQuestCreate(QuestModel input)
    {
        // Get currently logged user
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        long userId = long.Parse(user.FindFirst("id")!.Value);

        var request = new CreateQuestRequest
        {
            Title = input.Title,
            Description = input.Description,
            Deadline = input.Deadline,

            // Required fields not in modal:
            Status = QuestStatus.Backlog,
            CreatedById = userId,
            StartDate = DateTime.UtcNow,
            AssigneeId = null,
            FinishedDate = null
        };

        QuestDto created = await QuestService.CreateQuestAsync(request);

    }
    private Task HandleCancel()
    {
        Console.WriteLine("User cancelled quest creation");
        return Task.CompletedTask;
    }
}

<style>
    .filters {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f5f5f5;
        border-radius: 5px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-group label {
        font-weight: bold;
        font-size: 14px;
    }
    
    .filter-group input,
    .filter-group select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 150px;
    }

    .quest-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .quest-table th,
    .quest-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }

    .quest-table th {
        background-color: #ba61e6;
        color: white;
        font-weight: bold;
    }

    .quest-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    .quest-table tr:hover {
        background-color: #ddd;
    }
</style>