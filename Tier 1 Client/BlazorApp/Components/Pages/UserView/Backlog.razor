@page "/backlog"

@using ApiContracts.Quest
@using ApiContracts.User
@using BlazorApp.Components.ComponentItems
@using BlazorApp.Components.ComponentItems.ParameterEnums
@using BlazorApp.Components.Pages.Auth
@using BlazorApp.Services.Auth
@using BlazorApp.Services.Quest
@using BlazorApp.Components.ComponentItems.Quest

@inject IQuestService questService
@inject IUserService userService
@inject QuestHubService HubService

@implements IDisposable

<PageTitle>Backlog</PageTitle>

<AuthorizeView>
    <NotAuthorized>
        <RedirectToLogin/>
    </NotAuthorized>

    <Authorized>
        <h3>Backlog - All Quests</h3>
        
        <CreateQuestModal @ref="_createQuestModal"
                          ListOfUsers="@_allUsers"
                          OnQuestCreated="@OnQuestCreated"
                          OnCancel="@OnCreateCancelled" />

        @if (_isLoading)
        {
            <p>Loading...</p>
        }
        else if (_errorMessage != null)
        {
            <p style="color: red;">Error: @_errorMessage</p>
        }
        else
        {
            <div class="top-section">
                <div class="filters">
                    <div class="filter-group">
                        <label>Title:</label>
                        <input type="text" @bind="_titleFilter" @bind:event="oninput" placeholder="Search title..."/>
                    </div>

                    <div class="filter-group">
                        <label>Status:</label>
                        <select @bind="_statusFilter">
                            <option value="">All</option>
                            @foreach (var status in Enum.GetValues<QuestStatus>())
                            {
                                <option value="@status">@status</option>
                            }
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Created By:</label>
                        <select @bind="_userIdFilter">
                            <option value="">All</option>
                            @foreach (var user in _allUsers)
                            {
                                <option value="@user.Id">@user.DisplayName</option>
                            }
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Assignee:</label>
                        <select @bind="_assigneeFilter">
                            <option value="">All</option>
                            @foreach (var user in _allUsers)
                            {
                                <option value="@user.Id">@user.DisplayName</option>
                            }
                        </select>
                    </div>
                </div>
                
                <div>
                    <div class="w-100">
                        <Button Look="ButtonLook.Primary" Size="Size.Small" OnClick="@OpenModal">Create New Quest</Button>
                    </div>
                </div>
            </div>
            
            <p>Showing @GetFilteredQuests().Count of @_allQuests.Count quests</p>
            
            <table class="quest-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Created By</th>
                        <th>Assignee</th>
                        <th>Start Date</th>
                        <th>Deadline</th>
                        <th>Finished Date</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var quest in GetFilteredQuests())
                    {
                        <tr>
                            <td>@quest.Title</td>
                            <td>@quest.Description</td>
                            <td>@quest.Status</td>
                            <td>@quest.CreatedBy.DisplayName</td>
                            <td>@(quest.Assignee?.DisplayName ?? "-")</td>
                            <td>@(quest.StartDate?.ToShortDateString() ?? "-")</td>
                            <td>@(quest.Deadline?.ToShortDateString() ?? "-")</td>
                            <td>@(quest.FinishedDate?.ToShortDateString() ?? "-")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </Authorized>
</AuthorizeView>



@code {
    private List<QuestDto> _allQuests = new();
    private List<UserDto> _allUsers = new();
    private bool _isLoading = true;
    private string? _errorMessage;
    
    private CreateQuestModal? _createQuestModal;
    
    // Filter state
    private string _titleFilter = "";
    private string _statusFilter = "";
    private string _userIdFilter = "";
    private string _assigneeFilter = "";

    protected override async Task OnInitializedAsync()
    {
        await HubService.ConnectAsync("https://localhost:7009/questhub");
        // Subscribe to SignalR events
        HubService.OnQuestChanged += RefreshQuests;
        
        try
        {
            // Load both quests and users
            var questTask = questService.GetAllQuestsAsync();
            var userTask = userService.GetAllUsersAsync();
            
            await Task.WhenAll(questTask, userTask);
            
            _allQuests = questTask.Result;
            _allUsers = userTask.Result;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    //Called by SignalR when any quest changes
    private async void RefreshQuests()
    {
        try
        {
            // Reload only quests (users don't change)
            _allQuests = await questService.GetAllQuestsAsync();
            
            // Trigger UI refresh on Blazor thread
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }

    private List<QuestDto> GetFilteredQuests()
    {
        var filtered = _allQuests.AsEnumerable();
        
        // Filter by title
        if (!string.IsNullOrWhiteSpace(_titleFilter))
        {
            filtered = filtered.Where(q => 
                q.Title.Contains(_titleFilter, StringComparison.OrdinalIgnoreCase));
        }
        
        // Filter by status
        if (!string.IsNullOrWhiteSpace(_statusFilter))
        {
            var status = Enum.Parse<QuestStatus>(_statusFilter);
            filtered = filtered.Where(q => q.Status == status);
        }
        
        // Filter by user
        if (!string.IsNullOrWhiteSpace(_userIdFilter))
        {
            var userId = long.Parse(_userIdFilter);
            filtered = filtered.Where(q => q.CreatedBy.Id == userId);
        }
        
        // Filter by assignee
        if (!string.IsNullOrWhiteSpace(_assigneeFilter))
        {
            var assigneeId = long.Parse(_assigneeFilter);
            filtered = filtered.Where(q => q.Assignee != null && q.Assignee.Id == assigneeId);
        }

        return filtered.ToList();
    }

    // NEW METHOD: Cleanup on component dispose
    public void Dispose()
    {
        HubService.OnQuestChanged -= RefreshQuests;
    }
    
    private async Task OpenModal()
    {
        if (_createQuestModal != null)
            await _createQuestModal.ShowModal();
    }

    private async Task OnQuestCreated()
    {
        _allQuests = await questService.GetAllQuestsAsync();
        StateHasChanged();
    }

    private Task OnCreateCancelled()
    {
        return Task.CompletedTask;
    }
}