@page "/kanbanboard"


@inject IQuestService QuestService
@inject IUserService UserService
@inject QuestHubService HubService
@inject NavigationManager NavManager

@using System.Dynamic
@using ApiContracts.Quest
@using ApiContracts.User
@using BlazorApp.Components.ComponentItems
@using BlazorApp.Components.ComponentItems.KanbanBoard
@using BlazorApp.Components.ComponentItems.ParameterEnums
@using BlazorApp.Components.ComponentItems.Quest
@using BlazorApp.Components.Pages.Auth
@using BlazorApp.Services.Auth
@using BlazorApp.Services.Quest


@implements IDisposable
@* desired render mode define here *@
@rendermode InteractiveAuto

<AuthorizeView Context="auth">
    <NotAuthorized>
        <RedirectToLogin/>
    </NotAuthorized>
    
    <Authorized>
        <h3>Board - Quests to Work On</h3>

        @if (_isLoading)
        {
            <p>Loading...</p>
        }
        else if (_errorMessage != null)
        {
            <p style="color: red;">Error: @_errorMessage</p>
        }
        else
        {
            <CreateQuestModal @ref="_createQuestModal"
                              ListOfUsers="@_allUsers"
                              OnQuestCreated="@OnQuestCreated"
                              OnCancel="@OnCreateCancelled" />
            
                        <div class="top-section">
                <div class="filters">
                    <div class="filter-group">
                        <label>Title:</label>
                        <input type="text" @bind="_titleFilter" @bind:event="oninput" placeholder="Search title..."/>
                    </div>

                    <div class="filter-group">
                        <label>Created By:</label>
                        <select @bind="_userIdFilter">
                            <option value="">All</option>
                            @foreach (var user in _allUsers)
                            {
                                <option value="@user.Id">@user.DisplayName</option>
                            }
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Assignee:</label>
                        <select @bind="_assigneeFilter">
                            <option value="">All</option>
                            @foreach (var user in _allUsers)
                            {
                                <option value="@user.Id">@user.DisplayName</option>
                            }
                        </select>
                    </div>
                </div>
                
                <div>
                    <div class="w-100">
                        <Button Look="ButtonLook.Primary" Size="Size.Small" 
                                OnClick="@OpenModal">Create New Quest</Button>
                    </div>
                </div>
            </div>

            <p>Showing @GetFilteredQuests().Count of @_allQuests.Count quests</p>
            
            <SfKanban TValue="QuestKanbanModel"
                      KeyField="Status"
                      DataSource="@KanbanTasks"
                      AllowDragAndDrop="true">

                <KanbanColumns>
                    <KanbanColumn HeaderText="To Do" KeyField="@(new List<string>{ "ToDo" })" />
                    <KanbanColumn HeaderText="In Progress" KeyField="@(new List<string>{ "InProgress" })" />
                    <KanbanColumn HeaderText="Review" KeyField="@(new List<string>{ "Review" })" />
                    <KanbanColumn HeaderText="Done" KeyField="@(new List<string>{ "Finished" })" />
                </KanbanColumns>

                <KanbanCardSettings HeaderField="Id" ContentField="Summary">
                    <Template>
                        @{
                            var item = (QuestKanbanModel)context;
                        }

                        <div class="task-card">
                            <div class="task-id">Task @item.Id</div>
                            <div class="task-title">@item.Title</div>

                            @if (!string.IsNullOrWhiteSpace(item.Summary))
                            {
                                <div class="task-summary">@item.Summary</div>
                            }

                            <div class="task-footer">
                                <span class="task-assignee">@((item.Assignee ?? "Unassigned"))</span>
                            </div>
                        </div>
                    </Template>

                </KanbanCardSettings>
                <KanbanDialogSettings></KanbanDialogSettings>

                <KanbanEvents TValue="QuestKanbanModel"
                              DragStart="@DragStartHandler"
                              DragStop="@DragStopHandler" 
                              DialogClose="@CardDialogClose"/>

            </SfKanban>



        }

    </Authorized>
</AuthorizeView>



@code{
    private List<QuestDto> _allQuests = new();
    private List<UserDto> _allUsers = new();
    private bool _isLoading = true;
    private string? _errorMessage;

    private CreateQuestModal? _createQuestModal;
    
    // Filter state
    private string _titleFilter = "";
    private string _userIdFilter = "";
    private string _assigneeFilter = "";

    private List<QuestKanbanModel> KanbanTasks { get; set; } = new();

    private string? _dragSourceStatus;
    
    public class QuestKanbanModel
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public string Status { get; set; } = "";
        public string Summary { get; set; } = "";
        public string? Assignee { get; set; }
    }
    
    protected override async Task OnInitializedAsync()
    {
        // connect to SignalR and subscribe to updates
        await HubService.ConnectAsync("https://localhost:7009/questhub");
        HubService.OnQuestChanged += RefreshQuests;

        try
        {
            // load quests and users in parallel
            var questTask = QuestService.GetAllQuestsAsync();
            var userTask = UserService.GetAllUsersAsync();

            await Task.WhenAll(questTask, userTask);

            // store loaded data
            _allQuests = questTask.Result;
            _allUsers = userTask.Result;

            RefreshKanbanTasks(); // build kanban display list

            Console.WriteLine($"[INIT] Kanban tasks count = {KanbanTasks.Count}");
            foreach (var t in KanbanTasks)
            {
                Console.WriteLine($"[INIT] Task {t.Id}: Status = {t.Status}");
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    //Called by SignalR when any quest changes
    private async void RefreshQuests()
    {
        try
        {
            
            _allQuests = await QuestService.GetAllQuestsAsync();
            RefreshKanbanTasks(); // map to KanbanTasks
            await InvokeAsync(StateHasChanged); // trigger UI re-render

            Console.WriteLine("The Quest are :" + _allQuests.Count);

        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }

    private List<QuestDto> GetFilteredQuests()
    {
        var filtered = _allQuests.Where(q => q.Status != QuestStatus.Backlog).AsEnumerable();

        // Filter by title
        if (!string.IsNullOrWhiteSpace(_titleFilter))
        {
            filtered = filtered.Where(q =>
                q.Title.Contains(_titleFilter, StringComparison.OrdinalIgnoreCase));
        }

        // Filter by user
        if (!string.IsNullOrWhiteSpace(_userIdFilter))
        {
            var userId = long.Parse(_userIdFilter);
            filtered = filtered.Where(q => q.CreatedBy.Id == userId);
        }

        // Filter by assignee
        if (!string.IsNullOrWhiteSpace(_assigneeFilter))
        {
            var assigneeId = long.Parse(_assigneeFilter);
            filtered = filtered.Where(q => q.Assignee != null && q.Assignee.Id == assigneeId);
        }

        RefreshKanbanTasks();
        return filtered.ToList();
        
    }

    public void DragStartHandler(DragEventArgs<QuestKanbanModel> args)
    {
        // get the dragged card
        var card = args.Data?.FirstOrDefault();
        _dragSourceStatus = card?.Status;
    }

    //drag drop event handler
    public async Task DragStopHandler(DragEventArgs<QuestKanbanModel> args)
    {
        // get the dragged card
        var card = args.Data.FirstOrDefault();
        if (card == null)
            return;

        var newStatus = card.Status;

        // nothing to do if the card stayed in the same column
        if (_dragSourceStatus == newStatus)
            return;

        // parse the card id to long
        if (!long.TryParse(card.Id, out var questId))
            return;

        try
        {
            // find the original quest in the loaded list
            var originalQuest = _allQuests.First(q => q.Id == questId);

            // build updated dto keeping all fields same except status
            var updated = BuildUpdatedQuestDto(
                existing: originalQuest,
                editedCard: null,          // no changes from dialog
                newStatus: newStatus       // only status changed
            );
            // send the update request
            await QuestService.UpdateQuestAsync(questId, updated);
            Console.WriteLine($"Updated status of quest {questId} to {newStatus}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Drag update failed: " + ex.Message);
            // if it fails, revert the status back in UI
            if (_dragSourceStatus != null)
                card.Status = _dragSourceStatus;

            await InvokeAsync(StateHasChanged);
        }
        finally
        {
            _dragSourceStatus = null;
        }
    }
    
    // this method handles the kanban card menu closing
    // like if i hit save than it should send update request
    // if i hit delete send delete request
    public async Task CardDialogClose(DialogCloseEventArgs<QuestKanbanModel> args)
    {
        // dialog was cancelled
        if (args.Cancel)
            return;

        // DELETE
        if (args.RequestType == CurrentAction.Delete && args.Data != null)
        {
            //get the card data
            var card = args.Data;

            if (!long.TryParse(card.Id, out var questId))
                return;

            try //try sending the delete request
            {
                await QuestService.DeleteQuestAsync(questId);
                Console.WriteLine($"Deleted quest {questId}");
            }
            catch (Exception ex)
            {
                Console.WriteLine("Delete failed: " + ex.Message);
            }

            return;
        }

        // EDIT
        if (args.RequestType == CurrentAction.Edit && args.Data != null)
        {
            // get the card data
            var card = args.Data;

            if (!long.TryParse(card.Id, out var questId))
                return;

            //find the proper QuestDTO from allQuests by id (bc Card dont have all informations)
            var existing = _allQuests.FirstOrDefault(q => q.Id == questId);
            if (existing == null)
                return;

            //update the QuestDto with the card fields that we might changed
            var dto = new QuestDto
            {
                Id         = existing.Id,
                Title        = card.Title,
                Description  = string.IsNullOrWhiteSpace(card.Summary) ? null : card.Summary,
                CreatedBy    = existing.CreatedBy,
                Assignee     = existing.Assignee,
                CreatedDate  = existing.CreatedDate,
                StartDate    = existing.StartDate,
                Deadline     = existing.Deadline,
                FinishedDate = existing.FinishedDate,
                Status       = Enum.Parse<QuestStatus>(card.Status)
            };

            try //try sending the update request
            {
                await QuestService.UpdateQuestAsync(questId, dto);
                Console.WriteLine($"Updated quest {questId}");
            }
            catch (Exception ex)
            {
                Console.WriteLine("Edit failed: " + ex.Message);
            }
        }
    }

    private void RefreshKanbanTasks() //
    { 
        KanbanTasks = _allQuests
            .Where(q => q.Status != QuestStatus.Backlog)
            .Select(q => new QuestKanbanModel
            {
                Id       = q.Id.ToString(),
                Title    = q.Title,
                Status   = q.Status.ToString(),
                Summary  = q.Description ?? "",
                Assignee = q.Assignee?.DisplayName,
            })
            .ToList();
    }
    
    // NEW METHOD: Cleanup on component dispose
    public void Dispose()
    {
        HubService.OnQuestChanged -= RefreshQuests;
    }

    private QuestDto BuildUpdatedQuestDto(
        QuestDto existing,
        QuestKanbanModel? editedCard = null,
        string? newStatus = null)
    {
        return new QuestDto
        {
            Id           = existing.Id,
            // if dialog provided an edited card, take values from there, otherwise keep original
            Title        = editedCard?.Title      ?? existing.Title,
            Description  = editedCard?.Summary    ?? existing.Description,
            Assignee     = existing.Assignee, // or map from editedCard if you add assignee editing
            CreatedBy    = existing.CreatedBy,
            CreatedDate  = existing.CreatedDate,
            StartDate    = existing.StartDate,
            Deadline     = existing.Deadline,
            FinishedDate = existing.FinishedDate,
            Status       = newStatus != null 
                ? Enum.Parse<QuestStatus>(newStatus) 
                : existing.Status
        };
    }
    private async Task OpenModal()
    {
        if (_createQuestModal != null)
            await _createQuestModal.ShowModal();
    }

    private async Task OnQuestCreated()
    {
        _allQuests = await QuestService.GetAllQuestsAsync();
        StateHasChanged();
    }

    private Task OnCreateCancelled()
    {
        return Task.CompletedTask;
    }
}

    <style>
        .top-section{
            display: flex;
            justify-content: space-between;
            align-content: center;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .filters {
            display: flex;
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }

        .task-card {
            background: white;
            padding: 12px 14px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        }

        .task-id {
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        .task-summary {
            font-size: 14px;
            color: #4b5563;
            white-space: pre-wrap;
        }

        .task-footer {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
        }

        .task-assignee {
            font-size: 12px;
            color: #6b7280;
            padding: 4px 8px;
            border-radius: 6px;
            background: #f3f4f6;
        }


    </style>    
