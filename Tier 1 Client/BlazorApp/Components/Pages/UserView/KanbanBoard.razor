@page "/kanbanboard"
@page "/"

@inject IQuestService QuestService
@inject IUserService UserService
@inject QuestHubService HubService
@inject NavigationManager NavManager

@using System.Dynamic
@using ApiContracts.Quest
@using ApiContracts.User
@using BlazorApp.Components.ComponentItems.KanbanBoard
@using BlazorApp.Components.Pages.Auth
@using BlazorApp.Services.Auth
@using BlazorApp.Services.Quest
@implements IDisposable
@* desired render mode define here *@
@rendermode InteractiveAuto

<AuthorizeView>
    <NotAuthorized>
        <RedirectToLogin/>
    </NotAuthorized>
    
    <Authorized>
        <h3>Board - Quests to Work On</h3>

        @if (_isLoading)
        {
            <p>Loading...</p>
        }
        else if (_errorMessage != null)
        {
            <p style="color: red;">Error: @_errorMessage</p>
        }
        else
        {
            <div class="filters">
                <div class="filter-group">
                    <label>Title:</label>
                    <input type="text" @bind="_titleFilter" @bind:event="oninput" placeholder="Search title..."/>
                </div>

                <div class="filter-group">
                    <label>Created By:</label>
                    <select @bind="_userIdFilter">
                        <option value="">All</option>
                        @foreach (var user in _allUsers)
                        {
                            <option value="@user.Id">@user.DisplayName</option>
                        }
                    </select>
                </div>

                <div class="filter-group">
                    <label>Assignee:</label>
                    <select @bind="_assigneeFilter">
                        <option value="">All</option>
                        @foreach (var user in _allUsers)
                        {
                            <option value="@user.Id">@user.DisplayName</option>
                        }
                    </select>
                </div>
            </div>

            <p>Showing @GetFilteredQuests().Count of @_allQuests.Count quests</p>
            
            <div class="d-flex flex-row gap-4 justify-content-start 
                        align-items-stretch w-100 h-100 p-4">
                @foreach (var status in Enum.GetValues<QuestStatus>().Where(s => s != QuestStatus.Backlog))
                {
                    <Column Status="@status"
                            QuestDtos="@GetFilteredQuests().Where(q => q.Status == status).ToList()" />
                }
            </div>
            
        }
        <SfKanban TValue="QuestKanbanModel" KeyField="Status" DataSource="@KanbanTasks">
            <KanbanColumns>
                <KanbanColumn HeaderText="To Do"       KeyField="@(new List<string>{"ToDo"})" />
                <KanbanColumn HeaderText="In Progress" KeyField="@(new List<string>{"InProgress"})" />
                <KanbanColumn HeaderText="Review"      KeyField="@(new List<string>{"Review"})" />
                <KanbanColumn HeaderText="Done"        KeyField="@(new List<string>{"Finished"})" />
            </KanbanColumns>
            <KanbanCardSettings HeaderField="Id" ContentField="Summary" />
            <KanbanEvents TValue="QuestKanbanModel" DragStop="@DragStopHandler" />
        </SfKanban>

        
    </Authorized>
</AuthorizeView>



@code{
    private List<QuestDto> _allQuests = new();
    private List<UserDto> _allUsers = new();
    private bool _isLoading = true;
    private string? _errorMessage;

    // Filter state
    private string _titleFilter = "";
    private string _userIdFilter = "";
    private string _assigneeFilter = "";

    
    
    public class QuestKanbanModel
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public string Status { get; set; } = "";
        public string Summary { get; set; } = "";
        public string? Assignee { get; set; }
    }

    private List<QuestKanbanModel> KanbanTasks { get; set; } = new();

    
    
    protected override async Task OnInitializedAsync()
    {
        await HubService.ConnectAsync("https://localhost:7009/questhub");
        // Subscribe to SignalR events
        HubService.OnQuestChanged += RefreshQuests;
        Console.WriteLine("init");
        try
        {
            // Load both quests and users
            var questTask = QuestService.GetAllQuestsAsync();
            var userTask = UserService.GetAllUsersAsync();

            await Task.WhenAll(questTask, userTask);

            _allQuests = questTask.Result;
            _allUsers = userTask.Result;
            
            RefreshKanbanTasks();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);  
        }
        
      
    }
    
    private void NavigateToLoginPage()
    {
        NavManager.NavigateTo("/login");
    }

    //Called by SignalR when any quest changes
    private async void RefreshQuests()
    {
        try
        {
            
            Console.WriteLine("starting to get the quests");
            _allQuests = await QuestService.GetAllQuestsAsync();
            RefreshKanbanTasks();               // map to KanbanTasks
            await InvokeAsync(StateHasChanged); // trigger UI re-render
            
            Console.WriteLine("The Quest are :" +_allQuests.Count);
            
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }

    private List<QuestDto> GetFilteredQuests()
    {
        var filtered = _allQuests.AsEnumerable();

        // Filter by title
        if (!string.IsNullOrWhiteSpace(_titleFilter))
        {
            filtered = filtered.Where(q =>
                q.Title.Contains(_titleFilter, StringComparison.OrdinalIgnoreCase));
        }

        // Filter by user
        if (!string.IsNullOrWhiteSpace(_userIdFilter))
        {
            var userId = long.Parse(_userIdFilter);
            filtered = filtered.Where(q => q.CreatedBy.Id == userId);
        }

        // Filter by assignee
        if (!string.IsNullOrWhiteSpace(_assigneeFilter))
        {
            var assigneeId = long.Parse(_assigneeFilter);
            filtered = filtered.Where(q => q.Assignee != null && q.Assignee.Id == assigneeId);
        }

        return filtered.ToList();
    }
    
    public void DragStopHandler(DragEventArgs<QuestKanbanModel> args)
    {
        // Here you can customize your code
    }
    
    private void RefreshKanbanTasks()
    {
        KanbanTasks = _allQuests.Select(q => new QuestKanbanModel {
            Id        = q.Id.ToString(),
            Title     = q.Title,
            Status    = q.Status.ToString(),        // or map enum â†’ string if you prefer
            Summary   = q.Description ?? "",
            Assignee  = q.Assignee != null ? q.Assignee.DisplayName : null
        }).ToList();
    }

    

    // NEW METHOD: Cleanup on component dispose
    public void Dispose()
    {
        HubService.OnQuestChanged -= RefreshQuests;
    }
}

    <style>
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }
    </style>    
