@page "/kanbanboard"
@attribute [Authorize]
@inject IQuestService QuestService
@inject IUserService UserService
@inject QuestHubService HubService

@using ApiContracts.Quest
@using ApiContracts.User
@using BlazorApp.Components.ComponentItems.KanbanBoard
@using BlazorApp.Services.Auth
@using BlazorApp.Services.Quest
@implements IDisposable

        <h3>Board - Quests to Work On</h3>

        @if (_isLoading)
        {
            <p>Loading...</p>
        }
        else if (_errorMessage != null)
        {
            <p style="color: red;">Error: @_errorMessage</p>
        }
        else
        {
            <div class="filters">
                <div class="filter-group">
                    <label>Title:</label>
                    <input type="text" @bind="_titleFilter" @bind:event="oninput" placeholder="Search title..."/>
                </div>

                <div class="filter-group">
                    <label>Created By:</label>
                    <select @bind="_userIdFilter">
                        <option value="">All</option>
                        @foreach (var user in _allUsers)
                        {
                            <option value="@user.Id">@user.DisplayName</option>
                        }
                    </select>
                </div>

                <div class="filter-group">
                    <label>Assignee:</label>
                    <select @bind="_assigneeFilter">
                        <option value="">All</option>
                        @foreach (var user in _allUsers)
                        {
                            <option value="@user.Id">@user.DisplayName</option>
                        }
                    </select>
                </div>
            </div>

            <p>Showing @GetFilteredQuests().Count of @_allQuests.Count quests</p>
            
            <div class="d-flex flex-row gap-4 justify-content-start 
                        align-items-stretch w-100 h-100 p-4">
                @foreach (var status in Enum.GetValues<QuestStatus>().Where(s => s != QuestStatus.Backlog))
                {
                    <Column Status="@status"
                                 QuestDtos="@GetFilteredQuests().Where(q => q.Status == status).ToList()" />
                }
            </div>
        }

@code{
    private List<QuestDto> _allQuests = new();
    private List<UserDto> _allUsers = new();
    private bool _isLoading = true;
    private string? _errorMessage;

    // Filter state
    private string _titleFilter = "";
    private string _userIdFilter = "";
    private string _assigneeFilter = "";

    
    protected override async Task OnInitializedAsync()
    {
        // Subscribe to SignalR events
        HubService.OnQuestChanged += RefreshQuests;

        try
        {
            // Load both quests and users
            var questTask = QuestService.GetAllQuestsAsync();
            var userTask = UserService.GetAllUsersAsync();

            await Task.WhenAll(questTask, userTask);

            _allQuests = questTask.Result;
            _allUsers = userTask.Result;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    //Called by SignalR when any quest changes
    private async void RefreshQuests()
    {
        try
        {
            // Reload only quests (users don't change)
            _allQuests = await QuestService.GetAllQuestsAsync();

            // Trigger UI refresh on Blazor thread
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }

    private List<QuestDto> GetFilteredQuests()
    {
        var filtered = _allQuests.AsEnumerable();

        // Filter by title
        if (!string.IsNullOrWhiteSpace(_titleFilter))
        {
            filtered = filtered.Where(q =>
                q.Title.Contains(_titleFilter, StringComparison.OrdinalIgnoreCase));
        }

        // Filter by user
        if (!string.IsNullOrWhiteSpace(_userIdFilter))
        {
            var userId = long.Parse(_userIdFilter);
            filtered = filtered.Where(q => q.CreatedBy.Id == userId);
        }

        // Filter by assignee
        if (!string.IsNullOrWhiteSpace(_assigneeFilter))
        {
            var assigneeId = long.Parse(_assigneeFilter);
            filtered = filtered.Where(q => q.Assignee != null && q.Assignee.Id == assigneeId);
        }

        return filtered.ToList();
    }

    // NEW METHOD: Cleanup on component dispose
    public void Dispose()
    {
        HubService.OnQuestChanged -= RefreshQuests;
    }
}

    <style>
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }
    </style>    
