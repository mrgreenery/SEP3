@inject NavigationManager Nav
@inject BlazorApp.Services.Auth.AuthProvider Auth

@code {
    private bool _checked;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Run once, after the component is actually interactive
        if (!firstRender || _checked)
            return;

        _checked = true;

        // Try to restore the user from localStorage (authState)
        await Auth.TryRestoreSessionAsync();

        // Ask AuthProvider for the *current* auth state
        var state          = await Auth.GetAuthenticationStateAsync();
        var isAuthenticated = state.User.Identity?.IsAuthenticated ?? false;

        // Only redirect if we are STILL not authenticated
        if (!isAuthenticated)
        {
            var uri = Nav.Uri;
            if (!uri.EndsWith("/login") && !uri.EndsWith("/register"))
            {
                Nav.NavigateTo("/login");
            }
        }
    }
}
